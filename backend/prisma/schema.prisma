generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  logoUrl   String?  @map("logo_url")
  settings  String?  // JSON string
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users          User[]
  roles          Role[]
  jobs           Job[]
  ramsDocuments  RamsDocument[]
  templates      Template[]
  knowledgeItems KnowledgeBaseItem[]

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String   @unique
  passwordHash   String   @map("password_hash")
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  roleId         String   @map("role_id")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role            @relation(fields: [roleId], references: [id])
  createdJobs    Job[]           @relation("JobCreator")
  createdRams    RamsDocument[]  @relation("RamsCreator")
  approvedRams   RamsDocument[]  @relation("RamsApprover")
  generatedFiles GeneratedFile[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Role {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  permissions    String   // JSON string
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users        User[]

  @@unique([organizationId, name])
  @@map("roles")
}

model Job {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  projectName     String    @map("project_name")
  referenceNumber String?   @map("reference_number")
  clientName      String    @map("client_name")
  mainContractor  String?   @map("main_contractor")
  siteAddress     String    @map("site_address")
  sitePostcode    String    @map("site_postcode")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  scopeOfWorks    String    @map("scope_of_works")
  createdById     String    @map("created_by_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy     User           @relation("JobCreator", fields: [createdById], references: [id])
  ramsDocuments RamsDocument[]

  @@index([organizationId])
  @@index([sitePostcode])
  @@map("jobs")
}

model RamsDocument {
  id             String    @id @default(uuid())
  jobId          String    @map("job_id")
  organizationId String    @map("organization_id")
  title          String
  version        Int       @default(1)
  status         String    @default("draft")
  content        String    // JSON string
  createdById    String    @map("created_by_id")
  approvedById   String?   @map("approved_by_id")
  approvedAt     DateTime? @map("approved_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  job            Job             @relation(fields: [jobId], references: [id], onDelete: Cascade)
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User            @relation("RamsCreator", fields: [createdById], references: [id])
  approvedBy     User?           @relation("RamsApprover", fields: [approvedById], references: [id])
  generatedFiles GeneratedFile[]

  @@index([jobId])
  @@index([organizationId])
  @@index([status])
  @@map("rams_documents")
}

model Template {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  fileUrl        String   @map("file_url")
  fileType       String   @default("docx") @map("file_type")
  isDefault      Boolean  @default(false) @map("is_default")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  generatedFiles GeneratedFile[]

  @@index([organizationId])
  @@index([isDefault])
  @@map("templates")
}

model GeneratedFile {
  id            String   @id @default(uuid())
  ramsId        String   @map("rams_id")
  fileType      String   @map("file_type")
  fileUrl       String   @map("file_url")
  templateId    String?  @map("template_id")
  generatedById String   @map("generated_by_id")
  generatedAt   DateTime @default(now()) @map("generated_at")

  rams        RamsDocument @relation(fields: [ramsId], references: [id], onDelete: Cascade)
  template    Template?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  generatedBy User         @relation(fields: [generatedById], references: [id])

  @@index([ramsId])
  @@map("generated_files")
}

model KnowledgeBaseItem {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  title          String
  content        String
  category       String   @default("general")
  fileUrl        String?  @map("file_url")
  fileType       String?  @map("file_type")
  tags           String   @default("")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@map("knowledge_base_items")
}
